// üìÅ File: package.json
{
  "name": "goblinreach-backend",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "dependencies": {
    "@supabase/supabase-js": "^2.45.0",
    "jsonwebtoken": "^9.0.2",
    "micro": "^10.0.1",
    "raw-body": "^2.5.2"
  }
}

// üìÅ File: vercel.json
{
  "version": 2,
  "functions": {
    "api/**/*.js": {
      "runtime": "nodejs20.x"
    }
  }
}

// üìÅ File: api/auth/_supabase.js
import { createClient } from '@supabase/supabase-js';

export function supaAdmin() {
  const url = process.env.SUPABASE_URL;
  const key = process.env.SUPABASE_SERVICE_ROLE; // service role key (server only)
  if (!url || !key) throw new Error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE');
  return createClient(url, key, { auth: { persistSession: false } });
}

// Minimal JWT (for your app session)
import jwt from 'jsonwebtoken';
export function signAppToken(payload) {
  const secret = process.env.APP_JWT_SECRET;
  if (!secret) throw new Error('Missing APP_JWT_SECRET');
  return jwt.sign(payload, secret, { expiresIn: '30d' });
}

// üìÅ File: api/auth/signup.js
import { supaAdmin, signAppToken } from './_supabase.js';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  const { email, password, username } = req.body || {};
  if (!email || !password || !username) return res.status(400).json({ error: 'Missing email/password/username' });

  try {
    const supa = supaAdmin();
    // create auth user
    const { data: auth, error: e1 } = await supa.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
      user_metadata: { username }
    });
    if (e1) throw e1;

    const user = auth.user;
    // upsert profile row
    const { error: e2 } = await supa.from('profiles').upsert({
      user_id: user.id,
      username,
      plan: 'free',
      status: 'pending'
    });
    if (e2) throw e2;

    const token = signAppToken({ uid: user.id, username });
    return res.status(200).json({ token });
  } catch (err) {
    return res.status(500).json({ error: err.message || 'Signup failed' });
  }
}

// üìÅ File: api/auth/login.js
import { supaAdmin, signAppToken } from './_supabase.js';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  const { identifier, password } = req.body || {};
  if (!identifier || !password) return res.status(400).json({ error: 'Missing identifier/password' });

  try {
    const supa = supaAdmin();

    // Find user by email first
    let { data: usersByEmail } = await supa.auth.admin.listUsers({ page: 1, perPage: 1, email: identifier });
    let user = usersByEmail?.users?.[0];

    // If not email, try by username (stored in metadata)
    if (!user) {
      const { data, error } = await supa
        .from('profiles')
        .select('user_id, username')
        .eq('username', identifier)
        .single();
      if (!error && data) {
        const { data: userFetch } = await supa.auth.admin.getUserById(data.user_id);
        user = userFetch?.user;
      }
    }

    if (!user) return res.status(400).json({ error: 'User not found' });

    // Create a short-lived email OTP to verify password (Supabase Admin API cannot verify password directly).
    // Simpler approach: use public anon key on client for email/pass sign-in.
    return res.status(501).json({ error: 'Use client-side Supabase signInWithPassword or add a password proxy here.' });
  } catch (err) {
    return res.status(500).json({ error: err.message || 'Login failed' });
  }
}

// Alternative: client-side login snippet for index.html (uses anon key safely on client):
// const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// const { data, error } = await supa.auth.signInWithPassword({ email, password });
// if(!error){ const token = await supa.auth.getSession(); }

// üìÅ File: api/stripe/webhook.js
import { buffer } from 'micro';
import crypto from 'crypto';
import { supaAdmin } from '../auth/_supabase.js';

export const config = { api: { bodyParser: false } };

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');
  const sig = req.headers['stripe-signature'];
  const secret = process.env.STRIPE_WEBHOOK_SECRET;
  if (!secret) return res.status(500).send('Missing STRIPE_WEBHOOK_SECRET');

  const raw = await buffer(req);
  // Basic signature check (manual) ‚Äì if you use official stripe, swap to stripe.webhooks.constructEvent
  const digest = crypto.createHmac('sha256', secret).update(raw).digest('hex');
  // NOTE: For production, use Stripe SDK. Here we assume your reverse proxy sets X-Signature or you compare at your worker.

  try {
    const event = JSON.parse(raw.toString());
    if (event.type === 'checkout.session.completed') {
      const email = event.data.object.customer_details?.email;
      if (email) {
        const supa = supaAdmin();
        // find profile by email (user metadata)
        const { data: users } = await supa.auth.admin.listUsers({ page: 1, perPage: 1, email });
        const user = users?.users?.[0];
        if (user) {
          await supa.from('profiles').update({ plan: 'pro', status: 'active' }).eq('user_id', user.id);
        }
      }
    }
    return res.status(200).send('ok');
  } catch (e) {
    return res.status(400).send('Webhook error');
  }
}

// üìÅ File: supabase.sql (run in Supabase SQL editor)
/*
create table if not exists profiles (
  user_id uuid primary key references auth.users(id) on delete cascade,
  username text unique,
  plan text default 'free',
  status text default 'pending',
  created_at timestamp with time zone default now()
);

alter table profiles enable row level security;
create policy "public read own" on profiles for select using ( auth.uid() = user_id );
create policy "insert own" on profiles for insert with check ( auth.uid() = user_id );
create policy "update own" on profiles for update using ( auth.uid() = user_id );
*/

// üìÅ File: .env (set these in Vercel ‚Üí Project ‚Üí Settings ‚Üí Environment Variables)
/*
SUPABASE_URL=https://YOUR-PROJECT.ref.supabase.co
SUPABASE_SERVICE_ROLE=eyJ... (Service role key)
APP_JWT_SECRET=super-long-random-string
STRIPE_WEBHOOK_SECRET=whsec_... (from Stripe dashboard)
*/
